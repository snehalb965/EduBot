<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>EduAssist - AI School Admission Assistant</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f9f9fb;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #6a0dad;
      color: white;
      padding: 20px;
      text-align: center;
      font-size: 1.5em;
    }

    .container {
      max-width: 800px;
      margin: auto;
      padding: 20px;
    }

    .section {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }

    label {
      font-weight: 600;
      display: block;
      margin-top: 10px;
    }

    input, select, button, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-sizing: border-box;
      font-size: 1em;
    }

    button {
      background-color: #6a0dad;
      color: white;
      border: none;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background-color: #5a009d;
    }

    .chatbot {
      background: #f4f4f4;
      padding: 10px;
      border-radius: 8px;
      min-height: 120px;
      margin-top: 10px;
    }

    ul.school-list {
      list-style: none;
      padding: 0;
    }

    ul.school-list li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
    }

    .voice-button {
      margin-top: 10px;
      background-color: #4CAF50;
    }
    .input-wrapper {
      position: relative;
      width: 100%;
      max-width: 600px;
    }
    .input-wrapper input {
      width: 100%;
      padding: 12px 45px 12px 12px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      outline: none;
    }
    .speaker-btn {
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      font-size: 20px;
      cursor: pointer;
      color: #6a0dad;
      transition: 0.3s;
    }
    .speaker-btn:hover {
      opacity: 0.7;
    }
  </style>
</head>
<body>

<header>üéì EduAssist - AI-Powered School Admission Assistant</header>

<div class="container">

  <div class="section">
    <label>Select Language:</label>
    <select id="language">
      <option>English</option>
      <option>Tamil</option>
      <option>Hindi</option>
    </select>
  </div>
  <div class="section">
    <label>Enter Your Query:</label>
    <div class = "input-wrapper">
      <input type="text" id="userQuery" placeholder="e.g., Find schools near Salem for 10th standard">
      <span class ="speaker-btn" onclick="speakText(document.getElementById('userQuery').value, document.getElementById('language').value)">üîä</span>
    </div>
    <button onclick="sendQuery()">Ask EduAssist</button>
    <button class="voice-button" onclick="startVoice()">üé§ Speak</button>
    <div class="chatbot" id="chatbot">
      <p><strong>EduBot:</strong> Hello! I can help you find the best schools in your area.</p>
    </div>
  </div>

  <div class="section">
    <label>Search by Class and Location:</label>
    <input type="text" id="searchClass" placeholder="Enter Class (e.g., 6th)">
    <input type="text" id="searchLocation" placeholder="Enter Location (e.g., Erode)">
    <label>Preffeed School Type:</label>
    <select id="schoolType">
      <option value="government">Government</option>
      <option value="aided">Aided</option>
      <option value="private">Private</option>
    </select>
    <label>Maximum Distance Willing to Travel (km):</label>
    <select id="maxDistance">
      <option value="2">Within 2 km</option>
      <option value="5">Within 5 km</option>
      <option value="10">Within 10 km</option>
    </select>
    <label>Monthly Fee Range:</label>
    <select id="feeRange">
      <option value="free">Free</option>
      <option value="low">Below ‚Çπ500</option>
      <option value="medium">‚Çπ500‚Äì‚Çπ1500</option>
    </select>
    <label>
      <input type="checkbox" id="middayMeal"> Midday Meal Required
    </label>
    <label>
      <input type="checkbox" id="girlChild"> Girl Child
    </label>
    <button onclick="filterSchools()">Search</button>
  </div>

  <div class="section">
    <h3>üìö Recommended Schools</h3>
    <ul id="schoolList">
      <li data-class="10" data-location="Salem"><strong>Govt High School, Salem</strong> - Tamil Medium - State Board</li>
      <li data-class="6" data-location="Erode"><strong>Sunrise Matric School, Erode</strong> - English Medium - Matric</li>
      <li data-class="8" data-location="Namakkal"><strong>Sarvodaya Vidyalaya, Namakkal</strong> - CBSE - Hindi Medium</li>
    </ul>
  </div>

  <div class="section">
    <h3>üì§ Upload Admission Form</h3>
    <input type="file" id="formUpload">
    <button onclick="uploadForm()">Upload</button>
  </div>

  <div class="section">
    <h3>Contact Support</h3>
    <p>If you face any issues, contact our helpline: <strong>1800-123-EduBot</strong></p>
  </div>

</div>
<script src="libs/pdf-lib.min.js"></script>
<script>
  async function sendQuery() {
    const query = document.getElementById("userQuery").value;
    const chatbot = document.getElementById("chatbot");
    
    try {
      const res = await fetch('/api/chatbot/ask', {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ query })
      });
      
      const data = await res.json();
      
      if (!res.ok) {
        // Handle error response
        const errorMsg = data.message || data.error || 'An error occurred';
        const response = `<p><strong>You:</strong> ${query}</p>
                          <p><strong>EduBot:</strong> <span style="color: red;">Error: ${errorMsg}</span></p>`;
        chatbot.innerHTML += response;
      } else {
        // Handle success response
        const response = `<p><strong>You:</strong> ${query}</p>
                          <p><strong>EduBot:</strong> ${data.reply}</p>`;
        chatbot.innerHTML += response;
      }
    } catch (error) {
      // Handle network or other errors
      const response = `<p><strong>You:</strong> ${query}</p>
                        <p><strong>EduBot:</strong> <span style="color: red;">Error: Unable to connect to server. Please make sure the server is running.</span></p>`;
      chatbot.innerHTML += response;
      console.error('Error:', error);
    }
  }
  function speakText(text, language) {
    if (!document.getElementById("voiceToggle").checked) return;

    const utterance = new SpeechSynthesisUtterance(text);

    // Language mapping
    if (language === "Tamil") utterance.lang = "ta-IN";
    else if (language === "Hindi") utterance.lang = "hi-IN";
    else if (language === "Telugu") utterance.lang = "te-IN";
    else utterance.lang = "en-IN";

    utterance.rate = 0.9;   // slower for clarity
    utterance.pitch = 1;

    window.speechSynthesis.cancel(); // stop previous speech
    window.speechSynthesis.speak(utterance);
}
  async function loadSchools() {
  const res = await fetch("http://localhost:4000/api/schools");
  const schools = await res.json();

  const list = document.getElementById("schoolList");
  list.innerHTML = "";
  schools.forEach(school => {
    const li = document.createElement("li");
    li.dataset.class = school.class;
    li.dataset.location = school.location;
    li.innerHTML = `<strong>${school.name}</strong> - ${school.medium} Medium - ${school.board}`;
    list.appendChild(li);
  });
  }
  // filtering based on recommendation
  async function filterSchools() {
  try {
    // Collect user inputs
    const payload = {
      class: document.getElementById("searchClass").value.trim(),
      location: document.getElementById("searchLocation").value.toLowerCase(),
      type: document.getElementById("schoolType").value,
      maxDistance: parseInt(document.getElementById("maxDistance").value),
      fee: document.getElementById("feeRange").value,
      middayMeal: document.getElementById("middayMeal").checked,
      girlChild: document.getElementById("girlChild").checked
    };

    // Basic validation
    if (!payload.class || !payload.location) {
      alert("Please enter class and location");
      return;
    }

    // Call backend AI recommendation API
    const response = await fetch("http://localhost:4000/api/recommend", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const schools = await response.json();

    const list = document.getElementById("schoolList");
    list.innerHTML = "";

    // No results case
    if (!schools || schools.length === 0) {
      list.innerHTML = "<li>No matching schools found</li>";
      return;
    }

    // Display results
    schools.forEach(school => {
      const li = document.createElement("li");

      li.innerHTML = `
        <strong>${school.name}</strong><br>
        üìç Location: ${school.location}<br>
        üõ£ Distance: ${school.distance} km<br>
        üí∞ Fee: ‚Çπ${school.fee}<br>
        üè´ Type: ${school.type}<br>
        üçõ Midday Meal: ${school.middayMeal ? "Yes" : "No"}<br>
        üëß Girl Support: ${school.girlSupport ? "Yes" : "No"}<br>
        ‚≠ê Match Score: <b>${school.score}</b>
      `;

      list.appendChild(li);
    });

  } catch (error) {
    console.error("Filter error:", error);
    alert("Unable to fetch school recommendations");
  }
}

  async function uploadForm() {
    const fileInput = document.getElementById("formUpload");
    if (fileInput.files.length === 0) {
      alert("Please select a file first!");
    } else {
      alert("Form uploaded successfully (simulated).");
    }
    // Get user input
    const name = document.getElementById("studentName").value || "John Doe";
    const email = document.getElementById("studentEmail").value || "example@email.com";
    const phone = document.getElementById("studentPhone").value || "9876543210";

    // Load uploaded PDF
    const file = fileInput.files[0];
    const arrayBuffer = await file.arrayBuffer();
    const pdfDoc = await PDFLib.PDFDocument.load(arrayBuffer); // ‚úÖ notice PDFLib.PDFDocument

    const form = pdfDoc.getForm();

    try {
      // Fill form fields (field names must match your PDF!)
      form.getTextField("Name").setText(name);
      form.getTextField("Email").setText(email);
      form.getTextField("Phone").setText(phone);
    } catch (err) {
      alert("Could not find expected fields in this PDF. Please check field names.");
      console.error(err);
    }

    // Flatten (make filled data permanent)
    form.flatten();

    // Export updated PDF
    const pdfBytes = await pdfDoc.save();
    const blob = new Blob([pdfBytes], { type: "application/pdf" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "filled_admission_form.pdf";
    link.click();
  }
  function startVoice() {
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

  if (!SpeechRecognition) {
    alert("Voice recognition not supported in this browser. Use Chrome.");
    return;
  }

  const recognition = new SpeechRecognition();
  recognition.lang = document.getElementById("language").value;; // Change to ta-IN / hi-IN if needed
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;

  recognition.start();

  const chatbot = document.getElementById("chatbot");
  chatbot.innerHTML += `<p><em>üé§ Listening...</em></p>`;

  recognition.onresult = function (event) {
    const text = event.results[0][0].transcript;
    document.getElementById("userQuery").value = text;
    sendQuery(); // ‚úÖ Send to backend
  };
   
  recognition.onerror = function (event) {
    chatbot.innerHTML += `<p style="color:red;">Voice error: ${event.error}</p>`;
  };
}  
</script>

</body>
</html>
